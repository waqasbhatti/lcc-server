{% extends 'base.html' %}

{% block pagecontent %}

<!-- the top bar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">

  <a class="navbar-brand" href="/">LCC Server</a>

  <button class="navbar-toggler"
          type="button"
          data-toggle="collapse"
          data-target="#navbarNavAltMarkup"
          aria-controls="navbarNavAltMarkup"
          aria-expanded="false"
          aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
    <div class="navbar-nav">
      <a class="nav-item nav-link" href="/">
        Home
      </a>
      <a class="nav-item nav-link" href="/docs">Docs</a>
      <a class="nav-item nav-link active" href="/set/{{ setid }}">
        LCC Dataset {{ setid }}
      </a> <span class="sr-only">(current)</span>
    </div>
  </div>

  <form class="form-inline" action="/api/quicksearch" method="post">

    {% module xsrf_form_html() %}

    <select class="custom-select form-control" id="qt" name="qt">
      <option value="conesearch" selected>Quick cone search</option>
      <option value="objectidsearch">Quick object search</option>
      <option value="xmatchsearch">Quick cross-match search</option>
    </select>

    <div class="input-group">

      <input class="form-control ml-sm-2" id="q" name="q"
             type="search"
             placeholder="[RA] [Dec] [optional radius (arcmin)]"
             aria-label="Search">
      <div class="input-group-append">
        <button class="btn btn-outline-success my-2 my-sm-0"
                type="submit">Go</button>
      </div>

    </div>

  </form>

</nav>

<div class="container">

  <div class="row top-margin-row">
    <div class="col-12">

      <div class="accordion" id="accordionExample">

        <div class="card">
          <div class="card-header" id="headingOne">
            <h3 class="mb-0">
              <button class="btn btn-link"
                      type="button" data-toggle="collapse"
                      data-target="#collapseOne"
                      aria-expanded="true" aria-controls="collapseOne">
                Dataset metadata
              </button>
            </h3>
          </div>

          <div id="collapseOne" class="collapse show"
               aria-labelledby="headingOne" data-parent="#accordionExample">
            <div class="card-body">

              <table class="table table-borderless table-sm">

                <tr>
                  <th width="200">dataset ID</th>
                  <td>{{ header['setid'] }}</td>
                </tr>

                <tr>
                  <th width="200">created on</th>
                  <td><span class="moment-format">{{ header['created'] }}</span></td>
                </tr>

                <tr>
                  <th width="200">last updated</th>
                  <td><span class="moment-format">{{ header['updated'] }}</span></td>
                </tr>

                <tr>
                  <th width="200">dataset is public</th>
                  <td>{{ header['public'] }}</td>
                </tr>

                <tr>
                  <th width="200">search query type</th>
                  <td><code>{{ header['searchtype'] }}</code></td>
                </tr>

                <tr>
                  <th width="200">search query parameters</th>
                  <td><code>{{ header['searchargs'] }}</code></td>
                </tr>

                <tr>
                  <th width="200">total objects found</th>
                  <td><code>{{ header['nobjects'] }}</code></td>
                </tr>

                <tr>
                  <th width="200">objects found in collections</th>
                  <td><code>{{ ', '.join(header['collections']) }}</code></td>
                </tr>

              </table>

            </div>
          </div>
        </div>


        <div class="card">
          <div class="card-header" id="headingTwo">
            <h3 class="mb-0">
              <button class="btn btn-link collapsed"
                      type="button" data-toggle="collapse"
                      data-target="#collapseTwo"
                      aria-expanded="false" aria-controls="collapseTwo">
                Download data products
              </button>
            </h3>
          </div>
          <div id="collapseTwo" class="collapse"
               aria-labelledby="headingTwo" data-parent="#accordionExample">
            <div class="card-body">

              <table class="table table-borderless table-sm">

                <tr>
                  <th width="200">dataset JSON</th>
                  <td><a rel="nofollow" download="dataset-{{ setid }}.json" href="/set/{{ setid }}?json=1">download file</a></td>
                  <td></td>
                </tr>

                <tr>
                  <th width="200">dataset pickle</th>
                  <td><a rel="nofollow" href="{{ setpickle }}">download file</a></td>
                  <td>SHA256: <code>{{ setpickle_shasum }}</code></td>
                </tr>

                <tr>
                  <th width="200">dataset table CSV</th>
                  <td><a rel="nofollow" href="{{ setcsv }}">download file</a></td>
                  <td>SHA256: <code>{{ setcsv_shasum }}</code></td>
                </tr>

                <tr>
                  <th width="200">light curves ZIP</th>
                  <td><a rel="nofollow" href="{{ lczip }}">download file</a></td>
                  <td>SHA256: <code>{{ lczip_shasum }}</code></td>
                </tr>

                {% if cpzip is not None %}
                <tr>
                  <th width="200">checkplot pickles ZIP</th>
                  <td><a rel="nofollow" href="{{ cpzip }}">download file</a></td>
                  <td>SHA256: <code>{{ cpzip_shasum }}</code></td>
                </tr>
                {% end %}

                {% if pfzip is not None %}
                <tr>
                  <th width="200">period-finding results ZIP</th>
                  <td><a rel="nofollow" href="{{ pfzip }}">download file</a></td>
                  <td>SHA256: <code>{{ pfzip_shasum }}</code></td>
                </tr>
                {% end %}

              </table>

            </div>
          </div>
        </div>


        <div class="card">
          <div class="card-header" id="headingThree">
            <h3 class="mb-0">
              <button class="btn btn-link collapsed"
                      type="button" data-toggle="collapse"
                      data-target="#collapseThree"
                      aria-expanded="false" aria-controls="collapseThree">
                Data table column descriptions
              </button>
            </h3>
          </div>
          <div id="collapseThree" class="collapse"
               aria-labelledby="headingThree" data-parent="#accordionExample">
            <div class="card-body">

              <table class="table table-striped table-sm">

                <thead class="bg-light">
                  <tr id="table-columndesc">
                    <th width="100">column key</th>
                    <th width="150">title</th>
                    <th width="350">description</th>
                    <th width="100">numpy dtype</th>
                  </tr>
                </thead>

                <tbody id="table-datarows">
                  {% for col in header['columns'] %}
                  <tr>
                    <td width="100">
                      <code>{{ col }}</code>
                    </td>
                    <td width="150">
                      {% raw header['coldesc'][col]['title'] %}
                    </td>
                    <td width="350">
                      {% raw header['coldesc'][col]['desc'] %}
                    </td>
                    <td width="100">
                      <code>{{ header['coldesc'][col]['dtype'] }}</code>
                    </td>
                  </tr>
                  {% end %}

                </tbody>

              </table>

            </div>
          </div>
        </div>

      </div>

    </div>
  </div>

</div>


<!-- the full table -->
<div class="container-fluid">

  <div class="row mt-4 datatable-container">
    <div class="col-12">

      <table id="lcc-datatable" class="table table-striped table-sm dataset-table">

        <thead class="bg-light">
          <tr id="table-columndesc">
            {% for col in header['columns'] %}

            {% if 'f8' in header['coldesc'][col]['dtype'] or 'i8' in header['coldesc'][col]['dtype'] %}
            <th data-sort-method="number">{% raw header['coldesc'][col]['title'] %}</th>
            {% else %}
            <th>{% raw header['coldesc'][col]['title'] %}</th>
            {% end %}

            {% end %}
          </tr>
        </thead>

        <tbody id="table-datarows">

          {% for row in datarows %}
          <tr>
            {% for ci, cell in enumerate(row) %}
            {% set col = header['columns'][ci] %}
            <td>
              {% if ((col == 'lcfname' or col == 'db_lcfname') and cell is not None) %}
              <a rel="nofollow" href="{{ cell }}">download light curve file</a>
              {% elif ((col == 'lcfname' or col == 'db_lcfname') and cell is None) %}
              <span class="text-danger">not found/not public</span>
              {% elif col == 'collection' %}
              <code>{{ cell }}</code>
              {% else %}
              {{ header['coldesc'][col]['format'] % cell }}
              {% end %}
            </td>
            {% end %}
          </tr>
          {% end %}

        </tbody>

      </table>

    </div>
  </div>

</div>


{% end %}


{% block pagejs_modules %}

<!-- mathjs -->
<script src="{{ static_url('js/math.min.js') }}"></script>

<!-- our own js modules -->
<script src="{{ static_url('js/lcc-server.js') }}"></script>

{% end %}


{% block pagejs %}

$(document).ready(function() {


// UI action setup
lcc_ui.action_setup();

// format all the moments
$('.moment-format').each(function (index, elem) {

// get the text we need
var mt = moment($(this).text()).fromNow();
$(this).html($(this).text() + ' <strong>(' + mt + ')</strong>');

});



});

{% end %}
